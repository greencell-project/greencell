<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sign up - GreenCell</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji"; }
    .display-font { font-family: "Playfair Display", serif; }
  </style>
  <!-- Icon flicker fix: navbar leaf + name/role visibility -->
  <style id="gc-emoji-fix">
    #gc-nav .rounded-full.grid.place-content-center.text-white{position:relative;color:transparent}
    #gc-nav .rounded-full.grid.place-content-center.text-white::before{content:"\01F331";color:#fff;position:absolute;inset:0;display:grid;place-content:center}
    #gc-name,#gc-role,#gc-avatar{visibility:hidden}
  </style>
  <script>(function(){document.addEventListener('DOMContentLoaded',function(){var n=document.getElementById('gc-name');var r=document.getElementById('gc-role');var a=document.getElementById('gc-avatar');if(n) n.style.visibility='visible'; if(r) r.style.visibility='visible'; if(a) a.style.visibility='visible';});})();</script>
</head>
<body class="min-h-screen bg-gradient-to-br from-green-50 to-white">
  <div class="max-w-md mx-auto p-6">
    <a href="login.html" class="inline-flex items-center text-sm text-green-700 hover:underline mt-6 mb-4">&larr; Back to Login</a>
    <div class="bg-white/90 backdrop-blur rounded-2xl shadow-sm border border-gray-200 p-6">
      <div class="flex items-center gap-3 mb-4">
        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-600 to-green-800 flex items-center justify-center">
          <span class="text-white text-lg">ðŸŒ±</span>
        </div>
        <h1 class="display-font text-2xl font-bold text-gray-900">Create your account</h1>
      </div>

      <p class="text-sm text-gray-600 mb-6">Sign up to start tracking projects, learning progress, events and badges.</p>

      <form id="signup-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
          <input name="username" type="text" required minlength="3" maxlength="20" pattern="[a-zA-Z0-9_]+"
                 class="w-full px-4 py-2.5 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                 placeholder="e.g. adit" />
          <p class="text-xs text-gray-500 mt-1">Letters, numbers, underscores only. This will be shown instead of your email.</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Full name (optional)</label>
          <input name="full_name" type="text" class="w-full px-4 py-2.5 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="e.g. Emma Chen" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <input name="email" type="email" required class="w-full px-4 py-2.5 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="you@example.com" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
          <input name="password" type="password" required minlength="6" class="w-full px-4 py-2.5 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
        </div>

        <button type="submit" class="w-full bg-green-600 text-white py-2.5 rounded-lg font-semibold hover:bg-green-700">
          Create account
        </button>

        <div class="relative my-4">
          <div class="absolute inset-0 flex items-center"><div class="w-full border-t"></div></div>
          <div class="relative flex justify-center"><span class="bg-white px-2 text-xs text-gray-500">or</span></div>
        </div>

        <button type="button" id="google-btn" class="w-full border py-2.5 rounded-lg font-semibold hover:bg-gray-50 flex items-center justify-center gap-2">
          <svg width="18" height="18" viewBox="0 0 48 48" class="inline-block"><path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3C33.6 32.7 29.3 36 24 36c-6.6 0-12-5.4-12-12S17.4 12 24 12c3 0 5.7 1.1 7.7 2.9l5.7-5.7C34 5.1 29.3 3 24 3 12.4 3 3 12.4 3 24s9.4 21 21 21 21-9.4 21-21c0-1.2-.1-2.3-.4-3.5z"/><path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.7 16.4 19 13 24 13c3 0 5.7 1.1 7.7 2.9l5.7-5.7C34 5.1 29.3 3 24 3 16 3 9.2 7.4 6.3 14.7z"/><path fill="#4CAF50" d="M24 45c5.2 0 10-2 13.6-5.2l-6.3-5.3C29.4 36.4 26.8 37.5 24 37.5c-5.2 0-9.6-3.4-11.2-8.1l-6.6 5.1C8.9 40.6 15.9 45 24 45z"/><path fill="#1976D2" d="M43.6 20.5H42V20H24v8h11.3c-1.1 3.2-3.7 5.8-7.3 6.9l6.3 5.3C37.1 41.2 42 36 42 27c0-1.2-.1-2.3-.4-3.5z"/></svg>
          Continue with Google
        </button>

        <div class="text-sm text-center text-gray-600">
          Already have an account?
          <a class="text-green-700 hover:underline" href="login.html">Log in</a>
        </div>

        <div class="text-sm text-center">
          <a href="password-reset.html" class="text-gray-600 hover:underline">Forgot your password?</a>
        </div>
      </form>

      <div id="msg" class="mt-4 text-sm"></div>
    </div>
  </div>

  <script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const supabase = createClient(
    "https://zjxxmppahgpxoltdsfaq.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpqeHhtcHBhaGdweG9sdGRzZmFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMDA4NjIsImV4cCI6MjA3NTY3Njg2Mn0.VjYwkdE8g809JugkFy9KbrOAvMGwtKUCK4fDh8V7WVo"
  );

  // Builds an absolute URL while preserving the GitHub Pages subfolder (/greencell/)
  const abs = (p) => new URL(String(p).replace(/^\//,''), location.href).toString();

  // Honors ?returnTo=<page> if present, else uses a default (e.g., 'dashboard.html')
  const getReturnTo = (fallback = 'dashboard.html') =>
    new URLSearchParams(location.search).get('returnTo') || fallback;

  const form = document.getElementById("signup-form");
  const msg  = document.getElementById("msg");
  const submitBtn = form.querySelector('button[type="submit"]');

  // If already logged in, bounce
  {
    const { data: { session } } = await supabase.auth.getSession();
    if (session) {
      const rt = new URLSearchParams(location.search).get("returnTo") || "dashboard.html";
      location.href = rt;
    }
  }

  function setNotice(html, tone = "info") {
    const tones = {
      info:  "bg-blue-50 text-blue-800 border-blue-200",
      ok:    "bg-green-50 text-green-800 border-green-200",
      err:   "bg-red-50 text-red-800 border-red-200"
    };
    msg.className = `mt-4 text-sm p-3 rounded-lg border ${tones[tone] || tones.info}`;
    msg.innerHTML = html;
  }
  const escapeHtml = s => String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  function lock(btn, text="Creatingâ€¦"){ btn.disabled = true; btn.dataset._label = btn.textContent; btn.textContent = text; }
  function unlock(btn){ btn.disabled = false; if (btn.dataset._label) btn.textContent = btn.dataset._label; }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    setNotice("", "info");
    lock(submitBtn);

    const f = new FormData(form);
    const username  = (f.get("username")  || "").trim();
    const full_name = (f.get("full_name") || "").trim();
    const email     = (f.get("email")     || "").trim();
    const password  = (f.get("password")  || "").trim();

    if (!email || !password) {
      setNotice("Please enter an email and password.", "err");
      unlock(submitBtn);
      return;
    }

    const emailRedirectTo = abs('dashboard.html'); // works on Pages and localhost

    const { data, error } = await supabase.auth.signUp({
      email,
      password,
      options: {
        emailRedirectTo,
        data: {
          full_name: full_name || null,
          username:  username  || null
        }
      }
    });

    if (error) {
      setNotice(escapeHtml(error.message || "Sign up failed."), "err");
      unlock(submitBtn);
      return;
    }

    // If confirmations are ON: no session yet -> show clear â€œemail sentâ€ message + Resend
    if (data?.user && !data?.session) {
      setNotice(
        `We've sent a confirmation link to <strong>${escapeHtml(email)}</strong>.<br>
         Please check your inbox (and spam).<br>
         <button id="resendLink" class="underline font-medium">Resend email</button>`,
        "ok"
      );
      document.getElementById("resendLink")?.addEventListener("click", async () => {
        const { error: rErr } = await supabase.auth.resend({ type: "signup", email });
        if (rErr) setNotice(escapeHtml(rErr.message), "err");
        else setNotice(`Email resent to <strong>${escapeHtml(email)}</strong>.`, "ok");
      });
      unlock(submitBtn);
      return;
    }

    // If confirmations are OFF: you already have a session -> go in
    const rt = new URLSearchParams(location.search).get("returnTo") || "dashboard.html";
    location.href = rt;
  });

  // Google OAuth (unchanged)
// ---------- GOOGLE OAUTH: robust handler ----------
document.getElementById('google-btn')?.addEventListener('click', handleGoogle);

async function handleGoogle() {
  // Handle cases where page is opened as file:// (no origin)
  const fallbackOrigin = 'http://127.0.0.1:5500';
  const hasOrigin = location.origin && location.origin !== 'null' && location.origin !== 'file://';
  const base = hasOrigin ? location.origin : fallbackOrigin;

  // Where to land in your app after Supabase finishes Google flow
  const redirectTo = abs(getReturnTo('dashboard.html'));

  try {
    const { error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: {
        redirectTo,
        scopes: 'openid email profile',
        queryParams: { access_type: 'offline', prompt: 'consent' }
      }
    });
    if (error) setNotice(error.message, "err");
    // On success, the browser navigates away immediately.
  } catch (e) {
    setNotice(e?.message || 'Google sign-in failed to start.', 'err');
  }
}

 </script>
 <script src="js/emoji-fix.js"></script>

</body>
</html>





